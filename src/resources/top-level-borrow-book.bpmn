<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" xmlns:modeler="http://camunda.org/schema/modeler/1.0" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.18.0" modeler:executionPlatform="Camunda Cloud" modeler:executionPlatformVersion="8.4.0" camunda:diagramRelationId="2b165b7e-f373-45ed-b480-fa9c496e7a1a">
  <bpmn:process id="Process_0l7bwrn" name="Top-Level Borrow Book" isExecutable="true">
    <bpmn:startEvent id="StartEvent_BorrowBook" name="Borrow book">
      <bpmn:outgoing>Flow_1xyl9p1</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDefinition_0kcknf4" messageRef="Message_07bu8js" />
    </bpmn:startEvent>
    <bpmn:exclusiveGateway id="Gateway_1ma8y94" name="Book status">
      <bpmn:incoming>Flow_0stp45t</bpmn:incoming>
      <bpmn:outgoing>Flow_1ngi8a9</bpmn:outgoing>
      <bpmn:outgoing>Flow_060zhw6</bpmn:outgoing>
      <bpmn:outgoing>Flow_0vw2cyr</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_1xyl9p1" sourceRef="StartEvent_BorrowBook" targetRef="Activity_ChkBkSt" />
    <bpmn:endEvent id="Event_0tw82ts" name="No action possible">
      <bpmn:incoming>Flow_1ngi8a9</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_1ngi8a9" name="reserved" sourceRef="Gateway_1ma8y94" targetRef="Event_0tw82ts">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=BookStatus = reserved</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_060zhw6" name="available" sourceRef="Gateway_1ma8y94" targetRef="Activity_18wz0oh">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=BookStatus = available</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:subProcess id="Activity_18wz0oh" name="Manage book order">
      <bpmn:incoming>Flow_060zhw6</bpmn:incoming>
      <bpmn:incoming>Flow_1ckzfqi</bpmn:incoming>
      <bpmn:outgoing>Flow_0w47dr2</bpmn:outgoing>
    </bpmn:subProcess>
    <bpmn:exclusiveGateway id="Gateway_0fd7l8c" name="Reserve book?">
      <bpmn:incoming>Flow_1afe1ea</bpmn:incoming>
      <bpmn:outgoing>Flow_18qq6rv</bpmn:outgoing>
      <bpmn:outgoing>Flow_0c51kff</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_0vw2cyr" name="borrowed or ordered" sourceRef="Gateway_1ma8y94" targetRef="Event_MmbrIntent">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=list contains([ordered,borrowed], BookStatus)</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:endEvent id="Event_0wgcl3m" name="Book not reserved">
      <bpmn:incoming>Flow_18qq6rv</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_18qq6rv" name="No" sourceRef="Gateway_0fd7l8c" targetRef="Event_0wgcl3m">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=Var_MmbrIntent = no</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0c51kff" name="Yes" sourceRef="Gateway_0fd7l8c" targetRef="process_reserveBook">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">=Var_MmbrIntent = reserve</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0btsqs1" sourceRef="process_reserveBook" targetRef="Gateway_0fi4v31" />
    <bpmn:endEvent id="Event_12gclvz" name="Reservation cancelled">
      <bpmn:incoming>Flow_1qg29zb</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:exclusiveGateway id="Gateway_01v4q4d">
      <bpmn:incoming>Flow_0w47dr2</bpmn:incoming>
      <bpmn:outgoing>Flow_18yws3d</bpmn:outgoing>
      <bpmn:outgoing>Flow_16ssyvq</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_0w47dr2" sourceRef="Activity_18wz0oh" targetRef="Gateway_01v4q4d" />
    <bpmn:sequenceFlow id="Flow_18yws3d" name="book borrowed" sourceRef="Gateway_01v4q4d" targetRef="Activity_0lv0esl" />
    <bpmn:endEvent id="Event_1v90cng" name="Order cancelled">
      <bpmn:incoming>Flow_16ssyvq</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_16ssyvq" name="order cancelled" sourceRef="Gateway_01v4q4d" targetRef="Event_1v90cng" />
    <bpmn:subProcess id="Activity_0lv0esl" name="Manage borrowed book">
      <bpmn:incoming>Flow_18yws3d</bpmn:incoming>
      <bpmn:outgoing>Flow_1umpwh4</bpmn:outgoing>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="Flow_1umpwh4" sourceRef="Activity_0lv0esl" targetRef="Activity_0oki2n7" />
    <bpmn:subProcess id="Activity_0oki2n7" name="Return book">
      <bpmn:incoming>Flow_1umpwh4</bpmn:incoming>
      <bpmn:outgoing>Flow_06kzhjr</bpmn:outgoing>
    </bpmn:subProcess>
    <bpmn:endEvent id="Event_0mp731h" name="Book returned">
      <bpmn:incoming>Flow_06kzhjr</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_06kzhjr" sourceRef="Activity_0oki2n7" targetRef="Event_0mp731h" />
    <bpmn:eventBasedGateway id="Gateway_0fi4v31">
      <bpmn:incoming>Flow_0btsqs1</bpmn:incoming>
      <bpmn:outgoing>Flow_00z4r03</bpmn:outgoing>
      <bpmn:outgoing>Flow_015ig0h</bpmn:outgoing>
    </bpmn:eventBasedGateway>
    <bpmn:intermediateCatchEvent id="Event_CnclRsrv" name="cancel reservation">
      <bpmn:incoming>Flow_00z4r03</bpmn:incoming>
      <bpmn:outgoing>Flow_1qg29zb</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDefinition_1r7ipif" messageRef="Message_2hj6qc4" />
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="Flow_00z4r03" sourceRef="Gateway_0fi4v31" targetRef="Event_CnclRsrv" />
    <bpmn:sequenceFlow id="Flow_1qg29zb" sourceRef="Event_CnclRsrv" targetRef="Event_12gclvz" />
    <bpmn:intermediateCatchEvent id="Event_BkAvail" name="book returned or order canceled">
      <bpmn:incoming>Flow_015ig0h</bpmn:incoming>
      <bpmn:outgoing>Flow_1ckzfqi</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDefinition_1l4595e" messageRef="Message_2emr2s1" />
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="Flow_015ig0h" sourceRef="Gateway_0fi4v31" targetRef="Event_BkAvail" />
    <bpmn:sequenceFlow id="Flow_1ckzfqi" sourceRef="Event_BkAvail" targetRef="Activity_18wz0oh" />
    <bpmn:sequenceFlow id="Flow_0stp45t" sourceRef="Activity_ChkBkSt" targetRef="Gateway_1ma8y94" />
    <bpmn:userTask id="Activity_ChkBkSt" name="Check Book Status">
      <bpmn:extensionElements>
        <zeebe:ioMapping>
          <zeebe:output source="=status" target="BookStatus" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1xyl9p1</bpmn:incoming>
      <bpmn:outgoing>Flow_0stp45t</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:sequenceFlow id="Flow_1afe1ea" sourceRef="Event_MmbrIntent" targetRef="Gateway_0fd7l8c" />
    <bpmn:intermediateCatchEvent id="Event_MmbrIntent" name="Member Intent">
      <bpmn:extensionElements>
        <zeebe:ioMapping>
          <zeebe:output source="=whatIWantTo" target="Var_MmbrIntent" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0vw2cyr</bpmn:incoming>
      <bpmn:outgoing>Flow_1afe1ea</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDefinition_16dtsom" messageRef="Message_2setffc" />
    </bpmn:intermediateCatchEvent>
    <bpmn:userTask id="process_reserveBook" name="Reserve book">
      <bpmn:incoming>Flow_0c51kff</bpmn:incoming>
      <bpmn:outgoing>Flow_0btsqs1</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:textAnnotation id="TextAnnotation_128io0a">
      <bpmn:text>bizKey = bookId+memberID+uuid</bpmn:text>
    </bpmn:textAnnotation>
    <bpmn:association id="Association_18x4glk" sourceRef="StartEvent_BorrowBook" targetRef="TextAnnotation_128io0a" />
  </bpmn:process>
  <bpmn:message id="Message_07bu8js" name="Message_BorrowBook" />
  <bpmn:message id="Message_2setffc" name="Message_MemberIntent">
    <bpmn:extensionElements>
      <zeebe:subscription correlationKey="=bookId_mmberId_uuid" />
    </bpmn:extensionElements>
  </bpmn:message>
  <bpmn:message id="Message_2emr2s1" name="Message_BookAvailable">
    <bpmn:extensionElements>
      <zeebe:subscription correlationKey="=bookId_mmberId_uuid" />
    </bpmn:extensionElements>
  </bpmn:message>
  <bpmn:message id="Message_2hj6qc4" name="Message_CancelReservation">
    <bpmn:extensionElements>
      <zeebe:subscription correlationKey="=bookId_mmberId_uuid" />
    </bpmn:extensionElements>
  </bpmn:message>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_0l7bwrn">
      <bpmndi:BPMNShape id="TextAnnotation_128io0a_di" bpmnElement="TextAnnotation_128io0a">
        <dc:Bounds x="160" y="110" width="100" height="55" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1ma8y94_di" bpmnElement="Gateway_1ma8y94" isMarkerVisible="true">
        <dc:Bounds x="415" y="203" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="451" y="243" width="58" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0tw82ts_di" bpmnElement="Event_0tw82ts">
        <dc:Bounds x="532" y="82" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="505" y="125" width="90" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1tl7l70_di" bpmnElement="StartEvent_BorrowBook">
        <dc:Bounds x="192" y="210" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="179" y="253" width="62" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_0fd7l8c_di" bpmnElement="Gateway_0fd7l8c" isMarkerVisible="true">
        <dc:Bounds x="415" y="455" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="331" y="473" width="74" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_12gclvz_di" bpmnElement="Event_12gclvz">
        <dc:Bounds x="952" y="612" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="941" y="655" width="59" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_0u60qaa_di" bpmnElement="Gateway_0fi4v31">
        <dc:Bounds x="685" y="605" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_08w1oxe_di" bpmnElement="Event_CnclRsrv">
        <dc:Bounds x="802" y="612" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="775" y="655" width="90" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0kqwg5s_di" bpmnElement="Event_BkAvail">
        <dc:Bounds x="692" y="492" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="601" y="496" width="81" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0oci7za_di" bpmnElement="Activity_ChkBkSt">
        <dc:Bounds x="260" y="188" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0w65bse_di" bpmnElement="Event_MmbrIntent">
        <dc:Bounds x="422" y="332" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="332" y="340" width="71" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0wgcl3m_di" bpmnElement="Event_0wgcl3m">
        <dc:Bounds x="532" y="462" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="505" y="505" width="90" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0dirvi7_di" bpmnElement="process_reserveBook">
        <dc:Bounds x="390" y="590" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1762xpz_di" bpmnElement="Activity_18wz0oh">
        <dc:Bounds x="660" y="188" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_01v4q4d_di" bpmnElement="Gateway_01v4q4d" isMarkerVisible="true">
        <dc:Bounds x="845" y="203" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1v90cng_di" bpmnElement="Event_1v90cng">
        <dc:Bounds x="992" y="322" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="971" y="365" width="78" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1sjlcma_di" bpmnElement="Activity_0lv0esl">
        <dc:Bounds x="990" y="188" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1im87j2_di" bpmnElement="Activity_0oki2n7">
        <dc:Bounds x="1160" y="188" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0mp731h_di" bpmnElement="Event_0mp731h">
        <dc:Bounds x="1322" y="210" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1305" y="253" width="70" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Association_18x4glk_di" bpmnElement="Association_18x4glk">
        <di:waypoint x="210" y="210" />
        <di:waypoint x="210" y="165" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1xyl9p1_di" bpmnElement="Flow_1xyl9p1">
        <di:waypoint x="228" y="228" />
        <di:waypoint x="260" y="228" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1ngi8a9_di" bpmnElement="Flow_1ngi8a9">
        <di:waypoint x="440" y="203" />
        <di:waypoint x="440" y="100" />
        <di:waypoint x="532" y="100" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="434" y="152" width="43" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_060zhw6_di" bpmnElement="Flow_060zhw6">
        <di:waypoint x="465" y="228" />
        <di:waypoint x="660" y="228" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="541" y="210" width="44" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0vw2cyr_di" bpmnElement="Flow_0vw2cyr">
        <di:waypoint x="440" y="253" />
        <di:waypoint x="440" y="332" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="380" y="261" width="59" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18qq6rv_di" bpmnElement="Flow_18qq6rv">
        <di:waypoint x="465" y="480" />
        <di:waypoint x="532" y="480" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="491" y="462" width="15" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0c51kff_di" bpmnElement="Flow_0c51kff">
        <di:waypoint x="440" y="505" />
        <di:waypoint x="440" y="590" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="446" y="545" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0btsqs1_di" bpmnElement="Flow_0btsqs1">
        <di:waypoint x="490" y="630" />
        <di:waypoint x="685" y="630" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0w47dr2_di" bpmnElement="Flow_0w47dr2">
        <di:waypoint x="760" y="228" />
        <di:waypoint x="845" y="228" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18yws3d_di" bpmnElement="Flow_18yws3d">
        <di:waypoint x="895" y="228" />
        <di:waypoint x="990" y="228" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="906" y="210" width="73" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_16ssyvq_di" bpmnElement="Flow_16ssyvq">
        <di:waypoint x="870" y="253" />
        <di:waypoint x="870" y="340" />
        <di:waypoint x="992" y="340" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="847" y="294" width="76" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1umpwh4_di" bpmnElement="Flow_1umpwh4">
        <di:waypoint x="1090" y="228" />
        <di:waypoint x="1160" y="228" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_06kzhjr_di" bpmnElement="Flow_06kzhjr">
        <di:waypoint x="1260" y="228" />
        <di:waypoint x="1322" y="228" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_00z4r03_di" bpmnElement="Flow_00z4r03">
        <di:waypoint x="735" y="630" />
        <di:waypoint x="802" y="630" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1qg29zb_di" bpmnElement="Flow_1qg29zb">
        <di:waypoint x="838" y="630" />
        <di:waypoint x="952" y="630" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_015ig0h_di" bpmnElement="Flow_015ig0h">
        <di:waypoint x="710" y="605" />
        <di:waypoint x="710" y="528" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1ckzfqi_di" bpmnElement="Flow_1ckzfqi">
        <di:waypoint x="710" y="492" />
        <di:waypoint x="710" y="268" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0stp45t_di" bpmnElement="Flow_0stp45t">
        <di:waypoint x="360" y="228" />
        <di:waypoint x="415" y="228" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1afe1ea_di" bpmnElement="Flow_1afe1ea">
        <di:waypoint x="440" y="368" />
        <di:waypoint x="440" y="455" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
  <bpmndi:BPMNDiagram id="BPMNDiagram_0gemnsa">
    <bpmndi:BPMNPlane id="BPMNPlane_0xpsnwk" bpmnElement="Activity_18wz0oh" />
  </bpmndi:BPMNDiagram>
  <bpmndi:BPMNDiagram id="BPMNDiagram_05yxl2l">
    <bpmndi:BPMNPlane id="BPMNPlane_1930wcx" bpmnElement="Activity_0lv0esl" />
  </bpmndi:BPMNDiagram>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1t8feph">
    <bpmndi:BPMNPlane id="BPMNPlane_0vglccd" bpmnElement="Activity_0oki2n7" />
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
